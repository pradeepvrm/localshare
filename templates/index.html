<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LocalSendPy (Hub)</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <style>
        body { font-family: 'Inter', sans-serif; }
    </style>
</head>
<body class="bg-gray-900 text-gray-100 min-h-screen">
    
    <!-- Login Modal -->
    <div id="login-modal" class="fixed inset-0 bg-gray-900 bg-opacity-90 flex items-center justify-center z-50">
        <div class="bg-gray-800 p-8 rounded-lg shadow-xl w-full max-w-sm">
            <h2 class="text-2xl font-bold text-white mb-6">Welcome to LocalSendPy Hub</h2>
            <div class="mb-4">
                <label for="name-input" class="block text-sm font-medium text-gray-300 mb-2">Enter your name:</label>
                <input type="text" id="name-input" class="w-full bg-gray-700 border border-gray-600 rounded-md py-2 px-3 text-white focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="e.g., Alice">
            </div>
            <button id="login-btn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-md transition duration-200">
                Join Chat
            </button>
        </div>
    </div>

    <!-- Main App (Hidden by default) -->
    <div id="main-app" class="container mx-auto p-4 md:p-8 max-w-4xl hidden">
        <header class="mb-8">
            <h1 class="text-4xl font-bold text-white">LocalSend<span class="text-blue-400">Py</span> <span class="text-lg text-gray-400">(Hub Mode)</span></h1>
            <p class="text-lg text-gray-400">Your name: <span id="user-name-display" class="font-medium text-blue-300"></span></p>
        </header>

        <!-- Main Content Grid -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">

            <!-- Left Column: Users & Sender -->
            <div class="md:col-span-1 flex flex-col gap-6">

                <!-- Users List -->
                <div class="bg-gray-800 rounded-lg shadow-lg overflow-hidden">
                    <h2 class="text-xl font-semibold p-4 bg-gray-700 border-b border-gray-600">Online Users</h2>
                    <ul id="user-list" class="p-4 space-y-2 max-h-60 overflow-y-auto">
                        <li class="text-gray-400">Connecting...</li>
                    </ul>
                </div>

                <!-- Sender Card -->
                <div class="bg-gray-800 rounded-lg shadow-lg p-4">
                    <h2 class="text-xl font-semibold mb-4">Send Message/File</h2>
                    
                    <!-- User Selector -->
                    <div class="mb-4">
                        <label for="user-select" class="block text-sm font-medium text-gray-300 mb-1">Select Recipient:</label>
                        <select id="user-select" class="w-full bg-gray-700 border border-gray-600 rounded-md py-2 px-3 text-white focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="all">Send to Everyone</option>
                        </select>
                    </div>

                    <!-- Send Message -->
                    <div class="mb-4">
                        <label for="message-input" class="block text-sm font-medium text-gray-300 mb-1">Message:</label>
                        <textarea id="message-input" rows="3" class="w-full bg-gray-700 border border-gray-600 rounded-md py-2 px-3 text-white focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Type your message..."></textarea>
                        <button id="send-message-btn" class="mt-2 w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-md transition duration-200">
                            Send Message
                        </button>
                    </div>

                    <!-- Send File -->
                    <div>
                        <label for="file-input" class="block text-sm font-medium text-gray-300 mb-1">File:</label>
                        <input id="file-input" type="file" class="w-full text-sm text-gray-400 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-blue-100 file:text-blue-700 hover:file:bg-blue-200"/>
                        <button id="send-file-btn" class="mt-2 w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-md transition duration-200">
                            Send File
                        </button>
                    </div>
                </div>
            </div>

            <!-- Right Column: Received Content -->
            <div class="md:col-span-2 flex flex-col gap-6">
                <!-- Received Feed (Messages & Files) -->
                <div class="bg-gray-800 rounded-lg shadow-lg">
                    <h2 class="text-xl font-semibold p-4 bg-gray-700 border-b border-gray-600">Chat Feed</h2>
                    <div id="chat-window" class="p-4 space-y-4 max-h-96 overflow-y-auto">
                        <p class="text-gray-400">No messages received yet.</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Status/Error Message -->
        <div id="status-message" class="fixed bottom-4 right-4 p-4 rounded-lg shadow-lg text-white transition-opacity duration-300 opacity-0">
        </div>
    </div>

    <script>
        // --- Global State ---
        let myUserId = null;
        let myName = null;
        let lastMessageTimestamp = 0;
        let knownUserList = [];

        // --- Utility Functions ---
        function showStatus(message, isError = false) {
            const el = document.getElementById('status-message');
            if (!el) return;
            el.textContent = message;
            el.className = `fixed bottom-4 right-4 p-4 rounded-lg shadow-lg text-white transition-all duration-300 ${isError ? 'bg-red-600' : 'bg-green-600'} opacity-100 z-50`;
            setTimeout(() => {
                el.className = el.className.replace('opacity-100', 'opacity-0');
            }, 3000);
        }

        function formatTimestamp(ts) {
            return new Date(ts * 1000).toLocaleTimeString();
        }

        // --- Core Functions ---

        async function handleLogin() {
            const name = document.getElementById('name-input').value;
            if (!name) {
                showStatus('Please enter a name.', true);
                return;
            }

            try {
                const response = await fetch('/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name: name })
                });
                const result = await response.json();

                if (result.status === 'ok') {
                    myUserId = result.user_id;
                    myName = result.name;
                    document.getElementById('user-name-display').textContent = myName;
                    
                    // Hide login, show app
                    document.getElementById('login-modal').classList.add('hidden');
                    document.getElementById('main-app').classList.remove('hidden');

                    // Start background tasks
                    startAppPolls();
                } else {
                    showStatus(result.message, true);
                }
            } catch (error) {
                console.error('Login error:', error);
                showStatus('Could not connect to server.', true);
            }
        }

        function startAppPolls() {
            // Initial fetches
            fetchUsers();
            fetchUpdates();

            // Polling intervals
            setInterval(sendHeartbeat, 10000); // Send heartbeat every 10s
            setInterval(fetchUsers, 5000); // Poll for users every 5s
            setInterval(fetchUpdates, 2000); // Poll for messages every 2s
        }

        async function sendHeartbeat() {
            if (!myUserId) return;
            try {
                await fetch('/heartbeat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ user_id: myUserId })
                });
            } catch (error) {
                console.error('Heartbeat failed:', error);
            }
        }

        async function fetchUsers() {
            if (!myUserId) return;
            try {
                const response = await fetch('/users');
                const users = await response.json();
                knownUserList = users; // Save for later
                
                const userListEl = document.getElementById('user-list');
                const userSelectEl = document.getElementById('user-select');

                // --- Update User List (Card) ---
                if (users.length === 0) {
                    userListEl.innerHTML = '<li class="text-gray-400">Waiting for users...</li>';
                } else {
                    userListEl.innerHTML = users.map(user => `
                        <li class="flex justify-between items-center bg-gray-700 p-2 rounded-md">
                            <span class="font-medium text-white">${user.name} ${user.id === myUserId ? '(You)' : ''}</span>
                        </li>
                    `).join('');
                }

                // --- Update User Selector (Dropdown) ---
                const currentSelection = userSelectEl.value;
                userSelectEl.innerHTML = '<option value="all">Send to Everyone</option>'; // Reset
                users.forEach(user => {
                    if (user.id === myUserId) return; // Don't list self in sender
                    const option = document.createElement('option');
                    option.value = user.id;
                    option.textContent = user.name;
                    userSelectEl.appendChild(option);
                });
                
                // Restore selection
                if (users.find(u => u.id === currentSelection)) {
                    userSelectEl.value = currentSelection;
                }

            } catch (error) {
                console.error('Error fetching users:', error);
            }
        }

        async function fetchUpdates() {
            if (!myUserId) return;
            try {
                const response = await fetch(`/get/messages?user_id=${myUserId}&since=${lastMessageTimestamp}`);
                const messages = await response.json();

                if (messages.length === 0) return; // No new messages

                const chatWindowEl = document.getElementById('chat-window');
                
                // Clear placeholder on first message
                if (lastMessageTimestamp === 0 && chatWindowEl.querySelector('p')) {
                    chatWindowEl.innerHTML = '';
                }

                messages.forEach(msg => {
                    // Update timestamp
                    if (msg.timestamp > lastMessageTimestamp) {
                        lastMessageTimestamp = msg.timestamp;
                    }

                    // Determine sender
                    const isMine = msg.from_user_id === myUserId;
                    const senderName = isMine ? 'You' : msg.from_name;
                    
                    if (msg.type === 'message') {
                        appendChatMessage(chatWindowEl, senderName, msg.content, msg.timestamp, isMine, msg.to_user_id !== 'all');
                    } else if (msg.type === 'file') {
                        appendFileMessage(chatWindowEl, senderName, msg.content, msg.timestamp, isMine, msg.to_user_id !== 'all');
                    }
                });
                
                chatWindowEl.scrollTop = chatWindowEl.scrollHeight; // Auto-scroll
            } catch (error) {
                console.error('Error fetching messages:', error);
            }
        }

        function appendChatMessage(windowEl, sender, message, ts, isMine, isPrivate) {
            const msgEl = document.createElement('div');
            const alignClass = isMine ? 'items-end' : 'items-start';
            const bubbleClass = isMine ? 'bg-blue-600 text-white' : 'bg-gray-700';
            const privateLabel = isPrivate ? '<span class="text-xs text-yellow-400 ml-2">(Private)</span>' : '';

            msgEl.className = `flex flex-col ${alignClass} mb-3`;
            msgEl.innerHTML = `
                <div class="flex items-center mb-1">
                    <span class="font-semibold text-sm ${isMine ? 'text-blue-300' : 'text-gray-300'}">${sender}</span>
                    ${privateLabel}
                </div>
                <div class="${bubbleClass} p-3 rounded-lg max-w-xs shadow">
                    <p class="text-white">${message}</p>
                </div>
                <span class="text-xs text-gray-500 mt-1">${formatTimestamp(ts)}</span>
            `;
            windowEl.appendChild(msgEl);
        }

        function appendFileMessage(windowEl, sender, filename, ts, isMine, isPrivate) {
            const msgEl = document.createElement('div');
            const alignClass = isMine ? 'items-end' : 'items-start';
            const bubbleClass = isMine ? 'bg-green-700' : 'bg-gray-700';
            const privateLabel = isPrivate ? '<span class="text-xs text-yellow-400 ml-2">(Private)</span>' : '';

            msgEl.className = `flex flex-col ${alignClass} mb-3`;
            msgEl.innerHTML = `
                <div class="flex items-center mb-1">
                    <span class="font-semibold text-sm ${isMine ? 'text-green-300' : 'text-gray-300'}">${sender}</span>
                    ${privateLabel}
                </div>
                <div class="${bubbleClass} p-3 rounded-lg max-w-xs shadow">
                    <p class="text-sm text-gray-200 mb-2">Sent a file:</p>
                    <a href="/download/${filename}" class="font-medium text-white hover:underline break-all">${filename}</a>
                    <a href="/download/${filename}" class="mt-2 block w-full text-center px-3 py-1 bg-green-500 hover:bg-green-600 text-white text-sm font-medium rounded-md">Download</a>
                </div>
                <span class="text-xs text-gray-500 mt-1">${formatTimestamp(ts)}</span>
            `;
            windowEl.appendChild(msgEl);
        }

        async function sendMessage() {
            const userSelectEl = document.getElementById('user-select');
            const messageInputEl = document.getElementById('message-input');
            
            const to_user_id = userSelectEl.value;
            const message = messageInputEl.value;

            if (!message) {
                showStatus('Please type a message.', true);
                return;
            }
            
            try {
                const response = await fetch('/send/message', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        message: message,
                        from_user_id: myUserId,
                        to_user_id: to_user_id
                    })
                });

                if (!response.ok) throw new Error(`Server responded with ${response.status}`);
                
                const result = await response.json();
                if (result.status === 'ok') {
                    showStatus('Message sent!');
                    messageInputEl.value = ''; // Clear input
                    // It will show up on the next /get/messages poll
                } else {
                    showStatus(`Error: ${result.message}`, true);
                }
            } catch (error) {
                console.error('Error sending message:', error);
                showStatus(`Failed to send message.`, true);
            }
        }

        async function sendFile() {
            const userSelectEl = document.getElementById('user-select');
            const fileInputEl = document.getElementById('file-input');
            
            const to_user_id = userSelectEl.value;

            if (fileInputEl.files.length === 0) {
                showStatus('Please select a file to send.', true);
                return;
            }
            
            const file = fileInputEl.files[0];
            const formData = new FormData();
            formData.append('file', file);
            formData.append('from_user_id', myUserId);
            formData.append('to_user_id', to_user_id);

            try {
                showStatus('Uploading file, this may take a moment...');
                const response = await fetch('/send/file', {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) throw new Error(`Server responded with ${response.status}`);
                
                const result = await response.json();
                if (result.status === 'ok') {
                    showStatus(`File "${result.filename}" sent!`);
                    fileInputEl.value = null; // Clear input
                } else {
                    showStatus(`Error: ${result.message}`, true);
                }
            } catch (error) {
                console.error('Error sending file:', error);
                showStatus(`Failed to send file.`, true);
            }
        }

        // --- Event Listeners ---
        document.getElementById('login-btn').addEventListener('click', handleLogin);
        document.getElementById('name-input').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') handleLogin();
        });
        document.getElementById('send-message-btn').addEventListener('click', sendMessage);
        document.getElementById('send-file-btn').addEventListener('click', sendFile);
        
    </script>
</body>
</html>

